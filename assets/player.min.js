var player1,uuid,pmode,source,useHLS=!1,defaultres=0,noreload=!1,resOptions=[],onbuffer=!1,slow=!1;console.log("script loaded"),window.addEventListener("hashchange",(function(){console.log("hash changed"),!1!==dec64(window.location.href.split("#")[1])&&location.reload()})),document.addEventListener("DOMContentLoaded",(function(){document.title="Stream";const e=document.querySelector("video");var o=window.location.href.split("#");source=o[1],uuid=source;for(var t=2;t<o.length;t++)if(0===o[t].indexOf("uid="))uuid=o[t].split("uid=")[1];else if(0===o[t].indexOf("pmode="))pmode=o[t].split("pmode=")[1];else if(0===o[t].indexOf("res=")){var r=parseInt(o[t].split("res=")[1]);isNaN(r)||(defaultres=r)}else if(0===o[t].indexOf("t=")&&uuid!==source&&isStorage("localStorage"))localStorage.setItem("playback-"+uuid,o[t].replace("t=",""));else if(0===o[t].indexOf("noreload="))noreload=o[t].split("noreload=")[1];else if(0===o[t].indexOf("options="))var n=o[t].split("options=")[1];else 0===o[t].indexOf("onbuffer=")?onbuffer=o[t].split("onbuffer=")[1]:0===o[t].indexOf("slow=")&&(slow=!0);if("string"==typeof n){n=n.split(",");for(t=0;t<n.length;t++)resOptions[t]=parseInt(n[t])}if(void 0===source)return void shownotif("No video specified");if(!1===(source=dec64(source)))return void shownotif("URL Invalid");"undefined"!=typeof replacement&&(source=source.replace("bestanimescdn",replacement)),useHLS=source.includes(".m3u8");var a={controls:!0,seek:!0};if(isTouch())if(window.innerWidth>935)i=["rewind","play","fast-forward","progress","current-time","duration","mute","volume","settings","pip","airplay","fullscreen"];else{a.controls=!1;i=["rewind","play","fast-forward","progress","current-time","duration","settings","pip","airplay","fullscreen"]}else var i=["play","progress","current-time","duration","mute","volume","settings","pip","airplay","fullscreen"];const s={i18n:{play:"Play (K)",pause:"Pause (K)",mute:"Mute (M)",unmute:"Unmute (M)",enterFullscreen:"Enter fullscreen (F)",exitFullscreen:"Exit fullscreen (F)",qualityLabel:{0:"Auto"}},iconUrl:"/assets/lib/plyr3.6.9.svg",controls:i,tooltips:a,seekTime:5,keyboard:{focused:!0,global:!0},fullscreen:{iosNative:!0}};if(setTimeout((function(){var e=document.getElementById("videocontainer");if("block"!==e.style.display&&!1===videxpired)if(void 0===player1){var o=document.createElement("video");!1===noreload?location.replace(location.href+"#noreload=true"):Hls.isSupported()||o.canPlayType("application/vnd.apple.mpegURL")?videxpired||shownotif("If video doesn't load, try reload or clear cache"):shownotif("Your browser not support HLS. please update your browser")}else e.style.display="block"}),15e3),Hls.isSupported()&&useHLS){const o=new Hls;o.loadSource(source),console.log("loading hls..."),o.on(Hls.Events.MANIFEST_PARSED,(function(t,r){if(console.log("hls parsed"),void 0===player1){var n=o.levels.map((e=>e.height));n.push(0);const t=n.reverse();s.quality={default:0,options:t,forced:!0,onChange:e=>function(e){if(window.hls.levels.forEach(((o,t)=>{o.height===e?window.hls.nextLevel=t:0===e&&(window.hls.loadLevel=-1)})),isStorage("sessionStorage")&&!skipStore){var o=sessionStorage.getItem("quality");e!==o&&(sessionStorage.setItem("quality",e),sessionStorage.setItem("timeq",Date.now()))}}(e)},skipStore=!0,player1=new Plyr(e,s),plyrSetup(),skipStore=!1,!1===noreload&&setTimeout((function(){0===player1.currentTime&&0===player1.buffered&&location.replace(location.href+"#noreload=true")}),17e3)}else player1.play()}));o.on(Hls.Events.ERROR,(function(e,t){if(!0===t.fatal)if(t.type===Hls.ErrorTypes.NETWORK_ERROR)if(console.log("network error on hls load, retrying..."),++trycount<11){setTimeout((function(){checkvideo(source)}),500);var r=o.currentLevel;o.loadLevel=-1,o.startLoad(),setTimeout((()=>{o.loadLevel=r}),1e3)}else"fallback"===pmode?window.parent.postMessage("proxy#off","*"):"alt"===pmode?window.parent.postMessage("proxy#error#force","*"):void 0!==player1&&player1.playing||shownotif("Network error. Try reload or use other stream",6e5);else t.type===Hls.ErrorTypes.MEDIA_ERROR&&(console.log("media error, recovering..."),o.recoverMediaError(),player1.play());else if(t.details===Hls.ErrorDetails.FRAG_LOAD_ERROR&&"string"==typeof t.frag.relurl&&!1===o.autoLevelEnabled){r=o.currentLevel;o.stopLoad(),o.loadLevel=-1,o.startLoad(),setTimeout((()=>{o.loadLevel=r}),1e3)}})),o.attachMedia(e),window.hls=o}else{if(console.log("use native hls player"),player1=new Plyr(e,s),resOptions.length>1&&!isNaN(resOptions[0])){var l=[];0===defaultres&&(defaultres=720);for(t=0;t<resOptions.length;t++){var d=resOptions[t];isNaN(d)||l.push({src:source.replace(".m3u8","."+d+".m3u8"),size:d})}player1.source={type:"video",sources:l},resOptions.includes(defaultres)&&(player1.quality=defaultres)}else player1.source={type:"video",sources:[{src:source}]};plyrSetup();var u=document.getElementsByTagName("source");for(t=0;t<u.length;t++)u[t].addEventListener("error",nativeErr)}setTimeout((function(){slow?shownotif("Currently using slow server, normal server not available yet",1e4):!1!==isStorage("localStorage")||player1.playing||shownotif("your browser deny localstorage, player can't remember playback progress",1e4)}),5e3),window.addEventListener("message",handleMsg,!1)}));var skipStore=!1,trycount=0,tryAttempt=0;function nativeErr(){if(null!==player1.media.error&&4===player1.media.error.code?tryAttempt++:trycount++,tryAttempt<16)if(trycount<16){var e=document.querySelector("video");console.log("Reloading video...");var o=player1.currentTime;e.load(),e.play(),e.currentTime=o}else tryAttempt=17;else"fallback"===pmode?window.parent.postMessage("proxy#off","*"):"alt"===pmode?window.parent.postMessage("proxy#error#force","*"):player1.playing||shownotif("Your browser fail to play, try reload or change player",6e5)}function plyrSetup(){if(document.getElementById("videocontainer").style.display="block",window.addEventListener("orientationchange",(function(){Math.abs(window.orientation)>45&&Math.abs(window.orientation)<135?player1.fullscreen.enter():player1.fullscreen.exit()})),player1.on("seeking",(e=>{if(isTouch()&&window.innerWidth<935){var o=document.activeElement.dataset;"object"==typeof o&&["fast-forward","rewind"].includes(o.plyr)&&(player1.playing&&"rewind"===o.plyr&&player1.pause(),seekFast())}})),void 0!==screen.orientation&&(player1.on("enterfullscreen",(e=>{screen.orientation.lock("landscape").catch((function(e){}))})),player1.on("exitfullscreen",(e=>{screen.orientation.unlock()}))),player1.on("ended",(e=>{player1.duration>300&&player1.currentTime>player1.duration-1&&window.parent.postMessage("episode#forward","*")})),useHLS&&Hls.isSupported()||player1.on("error",nativeErr),document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled?(player1.on("enterfullscreen",(e=>{!0===player1.fullscreen.forceFallback&&window.parent.postMessage("fallback#fullscreen","*")})),player1.on("exitfullscreen",(e=>{!0===player1.fullscreen.forceFallback&&(player1.fullscreen.forceFallback=!1,window.parent.postMessage("fallback#exitfull","*"))}))):(player1.on("enterfullscreen",(e=>{window.parent.postMessage("fallback#fullscreen","*")})),player1.on("exitfullscreen",(e=>{window.parent.postMessage("fallback#exitfull","*")}))),document.addEventListener("keyup",(e=>{e.shiftKey&&"ArrowRight"===e.key?player1.forward(80):e.shiftKey&&"ArrowLeft"===e.key?player1.rewind(80):"]"===e.key||e.shiftKey&&"n"===e.key.toLowerCase()?window.parent.postMessage("episode#forward","*"):"["===e.key||e.shiftKey&&"b"===e.key.toLowerCase()?window.parent.postMessage("episode#backward","*"):"l"===e.key||"L"===e.key?window.parent.postMessage("light#toggle","*"):"."===e.key?(player1.pause(),player1.currentTime+=.04):","===e.key&&(player1.pause(),player1.currentTime-=.04)}),!1),player1.on("playing",(e=>{if(playfirsttime){if(playfirsttime=!1,isStorage("localStorage")){var o=localStorage.getItem("playback-"+uuid);null!==o&&(o=parseFloat(o),player1.duration-60>o&&(player1.currentTime=o))}if(isStorage("sessionStorage")){var t=sessionStorage.getItem("quality"),r=Date.now()-parseInt(sessionStorage.getItem("timeq"));!isNaN(t)&&r<432e5&&(defaultres=parseInt(t),console.log("use stored quality "+t))}skipStore=!0,player1.quality=defaultres,setTimeout((()=>{skipStore=!1}),500)}SSdisplayed&&screenshoot(),document.getElementById("notif").style.display="none"})),timeMonitor(),player1.touch){var e=player1.elements;e.poster.addEventListener("click",(function(){"1"===getComputedStyle(e.controls).opacity&&player1.togglePlay()}),!0)}(player1.muted||player1.volume<.1)&&(player1.muted=!1,player1.volume=1),player1.speed=1,console.log("plyr setup done"),setTimeout((()=>{doneload=!0}),500),!1!==onbuffer&&(checkBuffering(onbuffer),setInterval((function(){bufferCount>0&&bufferCount--}),2e3))}var pPaused=!0,buffering=!1,bufferCount=0,checkingBuffer=!1;function checkBuffering(e){if(!checkingBuffer){checkingBuffer=!0;var o=0,t=0,r=2*parseInt(e);isNaN(r)&&(r=40),setInterval((function(){t=player1.currentTime,!player1.paused&&!pPaused&&!player1.seeking&&t>1?(!buffering&&t<o&&(console.log("buffering"),buffering=!0),buffering&&t>o&&(console.log("not buffering anymore"),buffering=!1)):buffering=!1,pPaused=!!player1.paused,buffering&&bufferCount++,bufferCount===r&&(window.parent.postMessage("proxy#off","*"),bufferCount++),o=t+.05}),500)}}var monitorInterval,playfirsttime=!0;function timeMonitor(){isStorage("localStorage")&&(monitorInterval=setInterval((function(){!playfirsttime&&player1.playing&&localStorage.setItem("playback-"+uuid,player1.currentTime)}),2e3))}var seekLastTime,seeking=0;function seekFast(){var e=70;iOS()&&(e=50),seekLastTime<player1.currentTime?(1===seeking&&player1.forward(e),seeking=1):seekLastTime>player1.currentTime&&(2===seeking&&player1.rewind(e),seeking=2),seekLastTime=player1.currentTime,setTimeout((function(){seeking=0}),400)}var videxpired=!1,videochecked=!1;function checkvideo(e){if(!videochecked&&void 0===player1&&navigator.onLine){videochecked=!0;var o=new XMLHttpRequest;o.open("GET",e),o.timeout=15e3,o.onloadend=function(){if(200!==this.status){if(videxpired=!0,!1!==noreload)return"fallback"===pmode?(window.parent.postMessage("proxy#off","*"),void setTimeout((function(){shownotif("Video expired. Please use newer link")}),5e3)):void("alt"!==pmode?(shownotif("Video expired. Please wait about 10 seconds...",12e4),uuid.length<20&&(window.parent.postMessage("episode#report#"+uuid,"*"),setTimeout((function(){window.parent.postMessage("episode#reload","*")}),1e4))):window.parent.postMessage("proxy#error#force","*"));setTimeout((function(){location.replace(location.href+"#noreload=true")}),1e3)}},o.send()}}var doneload=!1,alreadyLoaded=!1;function handleMsg(e){if("screenshot"===e.data)screenshoot();else if("usewidescreen"===e.data)player1.fullscreen.forceFallback=!0,player1.fullscreen.enter();else if("autoplay"!==e.data||doneload){if(e.origin===location.origin&&e.data.includes("load#")&&(window.parent.postMessage("status#loaded","*"),!alreadyLoaded)){alreadyLoaded=!0;var o=e.data.split("#")[1];if(o.includes("//")){var t=window.document.createElement("script");t.src=o,document.head.appendChild(t)}}}else{doneload=!0,document.querySelector("video").autoplay=!0,e.source.postMessage("status#autoplaying","*")}}var SSdisplayed=!1,SSlocked=!1;function screenshoot(){if(!SSlocked){var e,o;if(SSlocked=!0,SSdisplayed)return e=document.getElementById("howtosave"),(o=document.getElementsByTagName("canvas")[0]).style.opacity="0",e.style.opacity="0",setTimeout((function(){o.remove(),e.remove(),SSlocked=!1}),500),void(SSdisplayed=!1);var t=document.querySelector("video");if(t.videoWidth<10)SSlocked=!1;else{var r="30%";window.innerWidth<800&&(r="50%"),(e=document.createElement("a")).style.cssText="opacity:0;text-decoration:none;position:fixed;width:"+r+";bottom:5px;right:5px;transition:all 0.4s ease;background-color:rgba(0,0,0,0.5);text-align:center;color:white;z-index:99;font-size:12px;",e.innerHTML="Right click image to save",e.id="howtosave",document.body.appendChild(e),(o=document.createElement("canvas")).style.cssText="position:fixed; width:100%; box-shadow:0px 2px 5px 2px #131313c7; bottom:0; right:0; transition: all 0.4s ease; opacity:1",o.width=t.videoWidth,o.height=t.videoHeight,o.getContext("2d").drawImage(t,0,0,o.width,o.height),document.body.appendChild(o),setTimeout((function(){o.style.width=r,o.style.bottom="5px",o.style.right="5px"}),50),setTimeout((function(){e.style.opacity="1";var t="";try{t=o.toDataURL("image/jpeg")}catch(e){console.log("can't convert img")}""!==t&&(e.innerHTML="click here to save",e.style.padding="5px 0",e.href=t,e.download=uuid+"_"+Math.floor(1e4*Math.random())+".jpg"),SSlocked=!1}),450),SSdisplayed=!0}}}function shownotif(e,o=4e5){var t=document.getElementById("notif");t.innerHTML=e,t.style.display="block",setTimeout((function(){t.style.display="none"}),o)}function isTouch(){return"ontouchstart"in window||navigator.maxTouchPoints>0&&navigator.maxTouchPoints<200}function iOS(){return["iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}function isStorage(e){try{var o=window[e],t="__storage_test__";return o.setItem(t,t),o.removeItem(t),!0}catch(e){return!1}}function dec64(e){if(void 0===e||""===e.trim())return!1;try{return atob(e)}catch(e){return!1}}